{
  "lexicon": 1,
  "id": "xyz.tisocial.journal.comment",
  "defs": {
    "main": {
      "type": "record",
      "description": "A comment on a journal entry, providing community support and discussion.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": ["text", "subject", "createdAt"],
        "properties": {
          "text": {
            "type": "string",
            "description": "The comment content.",
            "maxGraphemes": 1000,
            "maxLength": 10000
          },
          "subject": {
            "type": "ref",
            "ref": "#commentSubject",
            "description": "What this comment is responding to."
          },
          "reply": {
            "type": "ref",
            "ref": "#commentReply",
            "description": "If this is a reply to another comment."
          },
          "supportType": {
            "type": "string",
            "knownValues": ["emotional", "informational", "resource", "solidarity", "witness"],
            "description": "Type of support this comment provides."
          },
          "isFromVerifiedAccount": {
            "type": "boolean",
            "default": false,
            "description": "Whether comment is from a badge-verified account."
          },
          "triggerWarnings": {
            "type": "array",
            "description": "Content warnings for this comment.",
            "items": {
              "type": "string",
              "knownValues": [
                "medical_advice", "detailed_description", "personal_experience",
                "resource_recommendation", "emotional_content"
              ]
            },
            "maxLength": 3
          },
          "facets": {
            "type": "array",
            "description": "Rich text annotations (mentions, links, hashtags).",
            "items": {
              "type": "ref",
              "ref": "app.bsky.richtext.facet"
            }
          },
          "embed": {
            "type": "union",
            "description": "Embedded content in the comment.",
            "refs": [
              "app.bsky.embed.external",
              "app.bsky.embed.record"
            ]
          },
          "createdAt": {
            "type": "string",
            "format": "datetime",
            "description": "When the comment was created."
          }
        }
      }
    },
    "createComment": {
      "type": "procedure",
      "description": "Create a new comment on a journal entry.",
      "input": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["text", "subject"],
          "properties": {
            "text": {
              "type": "string",
              "description": "Comment text content.",
              "maxGraphemes": 1000,
              "maxLength": 10000
            },
            "subject": {
              "type": "ref",
              "ref": "#commentSubject",
              "description": "Subject being commented on."
            },
            "reply": {
              "type": "ref", 
              "ref": "#commentReply",
              "description": "If replying to another comment."
            },
            "supportType": {
              "type": "string",
              "knownValues": ["emotional", "informational", "resource", "solidarity", "witness"],
              "description": "Type of support provided."
            }
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["uri", "cid"],
          "properties": {
            "uri": {
              "type": "string",
              "format": "at-uri",
              "description": "URI of the created comment."
            },
            "cid": {
              "type": "string",
              "format": "cid",
              "description": "Content identifier of the comment."
            }
          }
        }
      },
      "errors": [
        {
          "name": "SubjectNotFound",
          "description": "Journal entry not found or not accessible."
        },
        {
          "name": "CommentsNotAllowed",
          "description": "Comments are not allowed on this journal entry."
        },
        {
          "name": "InsufficientPermissions",
          "description": "User lacks permissions to comment."
        }
      ]
    },
    "getComments": {
      "type": "query",
      "description": "Retrieve comments for a journal entry.",
      "parameters": {
        "type": "params",
        "required": ["uri"],
        "properties": {
          "uri": {
            "type": "string",
            "format": "at-uri",
            "description": "URI of the journal entry."
          },
          "sortBy": {
            "type": "string",
            "knownValues": ["created_at", "support_relevance", "verification_level"],
            "default": "created_at",
            "description": "How to sort comments."
          },
          "filterBySupport": {
            "type": "array",
            "description": "Filter by support type.",
            "items": {
              "type": "string",
              "knownValues": ["emotional", "informational", "resource", "solidarity", "witness"]
            }
          },
          "verifiedOnly": {
            "type": "boolean",
            "default": false,
            "description": "Only show comments from verified accounts."
          },
          "limit": {
            "type": "integer",
            "minimum": 1,
            "maximum": 100,
            "default": 50,
            "description": "Maximum number of comments to return."
          },
          "cursor": {
            "type": "string",
            "description": "Pagination cursor."
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["comments"],
          "properties": {
            "comments": {
              "type": "array",
              "items": {
                "type": "ref",
                "ref": "#commentView"
              }
            },
            "cursor": {
              "type": "string",
              "description": "Pagination cursor."
            }
          }
        }
      }
    },
    "deleteComment": {
      "type": "procedure",
      "description": "Delete a comment (author or moderator only).",
      "input": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["uri"],
          "properties": {
            "uri": {
              "type": "string",
              "format": "at-uri",
              "description": "URI of the comment to delete."
            }
          }
        }
      },
      "output": {
        "encoding": "application/json",
        "schema": {
          "type": "object",
          "required": ["success"],
          "properties": {
            "success": {
              "type": "boolean",
              "description": "Whether deletion was successful."
            }
          }
        }
      }
    },
    "commentSubject": {
      "type": "object",
      "description": "Subject being commented on.",
      "required": ["uri"],
      "properties": {
        "uri": {
          "type": "string",
          "format": "at-uri",
          "description": "URI of the journal entry."
        },
        "cid": {
          "type": "string",
          "format": "cid",
          "description": "CID of the journal entry."
        }
      }
    },
    "commentReply": {
      "type": "object",
      "description": "Reference to parent comment being replied to.",
      "required": ["root", "parent"],
      "properties": {
        "root": {
          "type": "ref",
          "ref": "com.atproto.repo.strongRef",
          "description": "Root comment in the thread."
        },
        "parent": {
          "type": "ref",
          "ref": "com.atproto.repo.strongRef",
          "description": "Immediate parent comment."
        }
      }
    },
    "commentView": {
      "type": "object", 
      "description": "Comment with author and metadata for display.",
      "required": ["uri", "cid", "author", "record", "indexedAt"],
      "properties": {
        "uri": {
          "type": "string",
          "format": "at-uri",
          "description": "URI of the comment."
        },
        "cid": {
          "type": "string",
          "format": "cid",
          "description": "Content identifier."
        },
        "author": {
          "type": "ref",
          "ref": "app.bsky.actor.defs#profileViewBasic",
          "description": "Comment author profile."
        },
        "record": {
          "type": "unknown",
          "description": "Comment record data."
        },
        "indexedAt": {
          "type": "string",
          "format": "datetime",
          "description": "When comment was indexed."
        },
        "replyCount": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of replies to this comment."
        },
        "supportCount": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of support reactions."
        },
        "viewerHasSupported": {
          "type": "boolean",
          "description": "Whether viewer has reacted with support."
        }
      }
    }
  }
}